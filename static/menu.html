<html ng-app="nebree8App">
  <head>

    <!-- Angular Material CSS now available via Google CDN; version 0.10 used here -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.10.0/angular-material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=RobotoDraft:300,400,500,700,400italic">
    <style>
    .drink-list img {
      max-height: 1em;
      max-width: 1em;
    }

    .selected-drink {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
    }
    </style>

  </head>
  <body>

    <!-- Angular Material Dependencies -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.17/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.17/angular-animate.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.17/angular-aria.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.17/angular-cookies.min.js"></script>


    <!-- Angular Material Javascript now available via Google CDN; version 0.10 used here -->
    <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.10.0/angular-material.min.js"></script>
    <script src="all_drinks"></script>  <!-- Load drink database -->
    <script>
    var nebree8App = angular.module('nebree8App', ['ngMaterial', 'ngCookies']);
    nebree8App.directive('focusOn', function() {
       return function(scope, elem, attr) {
          scope.$on(attr.focusOn, function(e) {
              elem[elem.length - 1].focus();
          });
       };
    });
    nebree8App.controller('DrinkAppCtrl', ['$scope', '$http', '$mdDialog', '$cookies', function($scope, $http, $mdDialog, $cookies) {
      console.log("DrinkAppCtrl constructor");
      $scope.query = '';
      $scope.selected_drink = null;
      $scope.user_name = $cookies.user_name || '';

      $http.get('/all_drinks').success(function(data) {
        $scope.db = data;
        $scope.selectDrink(data[0]); // debug
      });
      $scope.drinkUrl = function(n) {
        return n.toLowerCase().replace(/ /g, "_");
      }
      $scope.selectDrink = function(drink) {
        console.log("select", drink);
        $scope.selected_drink = angular.copy(drink);
      }
      $scope.cancelSelection = function() {
        console.log("cancel selection");
        $scope.selected_drink = null;
      }
      $scope.makeDrink = function(event) {
        var EnterNameController = ['$scope', '$mdDialog', function ($scope, $mdDialog, user_name) {
          $scope.user_name = user_name;
          $scope.$broadcast('dialogOpened');
          $scope.closeDialog = function() {
            $mdDialog.hide($scope.user_name);
          };
          $scope.cancel = function() {
            $mdDialog.hide(null);
          }
        }];
        $mdDialog.show({
          controller: EnterNameController,
          targetEvent: event,
          locals: { user_name: $scope.user_name },
          template: '<md-dialog>' +
                    ' <form ng-submit="closeDialog()"> ' +
                    ' <md-dialog-content>' +
                    '   What should we call you by? ' +
                    '   <input type="text" ng-model="user_name" focus-on="dialogOpened"> ' +
                    ' </md-dialog-content>' +
                    ' <div class="md-actions"> ' +
                    '  <md-button ng-click="cancel()">Cancel</md-button> ' +
                    '  <md-button type="submit" ng-disabled="!user_name" class="md-primary"> ' +
                    '      Make Drink</md-button> ' +
                    ' </div> ' +
                    ' </form> ' +
                    '</md-dialog>'
        })
        .then(function(answer) {
          console.log("answer", answer);
          if (answer) {
            $cookies.user_name = $scope.user_name = $scope.selected_drink.user_name = answer;
            $scope.drink_id = 'unknown';
            $http({
              'method': 'POST',
              'url': '/api/order',
              'params': {'recipe': $scope.selected_drink},
              'responseType': 'json'
            }).then(function(response) {
              console.log("response", response)
              $scope.drink_id = response.data.id;
            })
            console.log("Making drink ", $scope.selected_drink);
            $scope.selectDrink(null);
          }
        }, function() {
          console.log("dialog cancelled");
        });
      }
    }]);
    </script>
    
    <div class="container" ng-controller="DrinkAppCtrl">
      <input ng-model="query">
      <div class="drink-list">
        <div ng-repeat="drink in db | filter:{drink_name:query}">
          <div ng-click="selectDrink(drink)">
          <img ng-src="images/{{drinkUrl(drink.drink_name)}}.jpg">
          {{drink.drink_name}}
          </div>
        </div>
      </div>
      <div class="selected-drink" ng-show="selected_drink">
        <h3>{{selected_drink.drink_name}}</h3>
        <div class="ingredient" ng-repeat="ingredient in selected_drink.ingredients">
          {{ingredient.name}}{{ingredient.parts}} parts, {{ingredient.drops}} drops
          <md-slider min="0" max="10" ng-model="ingredient.parts" ng-show="ingredient.parts !== undefined"> 
          <md-slider min="0" max="6" ng-model="ingredient.drops" ng-show="ingredient.drops !== undefined"> 
        </div>
        <md-button ng-click="cancelSelection()">Cancel</md-button>
        <md-button ng-click="makeDrink($event)">Create</md-button>
      </div>
    </div>
  </body>
</html>
